<!-- frontend/static/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>eCFR Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background-color: #f5f5f5;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin: 20px auto;
      max-width: 1400px;
    }
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    h2 {
      color: #444;
      margin-top: 0;
    }
    #agency-hierarchy {
      width: 100%;
      height: 800px;
      overflow: auto;
      background: white;
    }
    #agency-hierarchy svg {
      background: white;
    }
    .node circle {
      cursor: pointer;
    }
    .node text {
      cursor: default;
    }
    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }
    .chart-container.hierarchy {
      grid-column: span 2;
    }
    .status-board {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }
    .status-card {
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .processing {
      background-color: #fff3cd;
    }
    .api-message {
      text-align: center;
      padding: 20px;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 4px;
      margin: 10px 0;
    }
    .api-message a {
      color: #0056b3;
      text-decoration: none;
      font-weight: bold;
    }
    .api-message a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>eCFR Analyzer Dashboard</h1>
  
  <div class="dashboard">
    <div class="chart-container">
      <h2>Word Count per Agency</h2>
      <canvas id="wordCountChart"></canvas>
    </div>

    <div class="chart-container">
      <h2>Historical Regulation Updates</h2>
      <canvas id="historicalChart"></canvas>
    </div>

    <div class="chart-container hierarchy">
      <h2>Agency Hierarchy</h2>
      <div id="agency-hierarchy"></div>
    </div>

    <div class="chart-container">
      <h2>Corrections Analysis</h2>
      <canvas id="correctionsChart"></canvas>
    </div>

    <div class="chart-container">
      <h2>Corrections Timeline</h2>
      <canvas id="correctionsTimelineChart"></canvas>
    </div>

    <div class="chart-container">
      <h2>Title Status</h2>
      <div id="titleStatus" class="status-board"></div>
    </div>
  </div>

  <script>
    // Existing word count chart
    fetch('/api/word_counts')
      .then(response => response.json())
      .then(data => {
        const agencies = Object.keys(data);
        const wordCounts = Object.values(data);
        const ctx = document.getElementById('wordCountChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: agencies,
            datasets: [{
              label: 'Word Count',
              data: wordCounts,
              backgroundColor: 'rgba(54, 162, 235, 0.5)'
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
          }
        });
      })
      .catch(err => console.error("Error fetching word counts:", err));

    // Existing historical changes chart
    fetch('/api/historical')
      .then(response => response.json())
      .then(data => {
        const dates = Object.keys(data);
        const updateCounts = Object.values(data);
        const ctx = document.getElementById('historicalChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Number of Updates',
              data: updateCounts,
              backgroundColor: 'rgba(255, 99, 132, 0.5)',
              borderColor: 'rgba(255, 99, 132, 1)',
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
          }
        });
      })
      .catch(err => console.error("Error fetching historical data:", err));

    // New Agency Hierarchy visualization using D3.js
    fetch('/api/agency_hierarchy')
      .then(response => response.json())
      .then(data => {
        // Check if we need to show API access message
        if (data.message && data.name === "API Access Required") {
          const container = document.getElementById('agency-hierarchy');
          container.innerHTML = `
            <div class="api-message">
              <h3>${data.name}</h3>
              <p>${data.message}</p>
              <p><a href="https://www.ecfr.gov/reader-aids/ecfr-developer-resources/rest-api-interactive-documentation" target="_blank">
                Click here to register your IP address
              </a></p>
            </div>
          `;
          return;
        }

        const margin = {top: 20, right: 120, bottom: 20, left: 300};
        const width = 1200 - margin.left - margin.right;
        const height = 800 - margin.top - margin.bottom;

        // Clear any existing content
        d3.select('#agency-hierarchy').html('');

        const svg = d3.select('#agency-hierarchy')
          .append('svg')
          .attr('width', width + margin.left + margin.right)
          .attr('height', height + margin.top + margin.bottom)
          .append('g')
          .attr('transform', `translate(${margin.left},${margin.top})`);

        const treeLayout = d3.tree()
          .size([height, width]);

        const root = d3.hierarchy(data);
        
        // Compute the new tree layout
        const tree = treeLayout(root);

        // Add links between nodes
        const link = svg.selectAll('.link')
          .data(tree.links())
          .enter()
          .append('path')
          .attr('class', 'link')
          .attr('d', d3.linkHorizontal()
            .x(d => d.y)
            .y(d => d.x))
          .style('fill', 'none')
          .style('stroke', '#ccc')
          .style('stroke-width', '1.5px');

        // Add nodes
        const node = svg.selectAll('.node')
          .data(tree.descendants())
          .enter()
          .append('g')
          .attr('class', 'node')
          .attr('transform', d => `translate(${d.y},${d.x})`);

        // Add circles for nodes
        node.append('circle')
          .attr('r', 5)
          .style('fill', '#69b3a2')
          .style('stroke', '#2c7c64')
          .style('stroke-width', '2px');

        // Add labels
        node.append('text')
          .attr('dy', '.35em')
          .attr('x', d => d.children ? -10 : 10)
          .style('text-anchor', d => d.children ? 'end' : 'start')
          .style('font-size', '12px')
          .style('font-family', 'Arial')
          .text(d => d.data.name)
          .each(function(d) {
            // Add titles (CFR references) if they exist
            if (d.data.titles && d.data.titles.length > 0) {
              d3.select(this.parentNode)
                .append('text')
                .attr('dy', '1.5em')
                .attr('x', d.children ? -10 : 10)
                .style('text-anchor', d.children ? 'end' : 'start')
                .style('font-size', '10px')
                .style('fill', '#666')
                .text(`Titles: ${d.data.titles.join(', ')}`);
            }
          });

        // Add zoom behavior
        const zoom = d3.zoom()
          .scaleExtent([0.5, 2])
          .on('zoom', (event) => {
            svg.attr('transform', event.transform);
          });

        d3.select('#agency-hierarchy svg')
          .call(zoom);
      })
      .catch(err => console.error("Error fetching agency hierarchy:", err));

    // New Corrections Analysis charts
    fetch('/api/corrections_analysis')
      .then(response => response.json())
      .then(data => {
        // Corrections by Title
        const ctx = document.getElementById('correctionsChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(data.by_title),
            datasets: [{
              label: 'Corrections per Title',
              data: Object.values(data.by_title),
              backgroundColor: 'rgba(75, 192, 192, 0.5)'
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
          }
        });

        // Corrections Timeline
        const timelineCtx = document.getElementById('correctionsTimelineChart').getContext('2d');
        new Chart(timelineCtx, {
          type: 'line',
          data: {
            labels: Object.keys(data.by_date),
            datasets: [{
              label: 'Corrections over Time',
              data: Object.values(data.by_date),
              borderColor: 'rgba(153, 102, 255, 1)',
              backgroundColor: 'rgba(153, 102, 255, 0.2)',
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
          }
        });
      })
      .catch(err => console.error("Error fetching corrections data:", err));

    // Title Status Board
    fetch('/api/title_status')
      .then(response => response.json())
      .then(data => {
        const statusBoard = document.getElementById('titleStatus');
        data.forEach(title => {
          const card = document.createElement('div');
          card.className = `status-card ${title.processing ? 'processing' : ''}`;
          card.innerHTML = `
            <h3>Title ${title.number}</h3>
            <p>${title.name}</p>
            <p>Last Amendment: ${title.latest_amendment || 'N/A'}</p>
            <p>Up to Date: ${title.up_to_date_as_of || 'N/A'}</p>
            ${title.processing ? '<p><em>Processing...</em></p>' : ''}
          `;
          statusBoard.appendChild(card);
        });
      })
      .catch(err => console.error("Error fetching title status:", err));
  </script>
</body>
</html>
