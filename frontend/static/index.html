<!-- frontend/static/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>eCFR Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background-color: #f5f5f5;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin: 20px auto;
      max-width: 1400px;
    }
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    h2 {
      color: #444;
      margin-top: 0;
    }
    #agency-hierarchy {
      width: 100%;
      height: 800px;
      overflow: auto;
      background: white;
      padding: 20px;
    }
    .agency-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    .agency-list ul {
      list-style: none;
      padding-left: 24px;
      margin: 0;
    }
    .agency-item {
      margin: 4px 0;
      padding: 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    .agency-item:hover {
      background-color: #f5f5f5;
    }
    .agency-header {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .agency-name {
      font-size: 14px;
      color: #333;
      flex: 1;
    }
    .agency-titles {
      font-size: 12px;
      color: #666;
      margin-left: 32px;
    }
    .toggle-btn {
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      border-radius: 3px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      color: #666;
      transition: all 0.2s;
    }
    .toggle-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .toggle-btn.leaf {
      visibility: hidden;
    }
    .agency-search {
      margin-bottom: 16px;
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .agency-search:focus {
      outline: none;
      border-color: #69b3a2;
      box-shadow: 0 0 0 2px rgba(105, 179, 162, 0.1);
    }
    .highlight {
      background-color: #fff3cd;
    }
    .node text {
      cursor: default;
      font-size: 11px;
      font-family: Arial;
    }
    .node-label {
      fill: #333;
    }
    .node-sublabel {
      fill: #666;
      font-size: 9px;
    }
    .node circle {
      cursor: pointer;
      fill: #fff;
      stroke: #69b3a2;
      stroke-width: 1.5px;
    }
    .node:hover circle {
      fill: #69b3a2;
    }
    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 0.5px;
      opacity: 0.4;
    }
    .text-background {
      fill: white;
      opacity: 0.9;
    }
    .chart-container.hierarchy,
    .chart-container:last-child {
      grid-column: span 2;
      overflow: hidden;
    }
    .status-board {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    .status-card {
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .processing {
      background-color: #fff3cd;
    }
    .api-message {
      text-align: center;
      padding: 20px;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 4px;
      margin: 10px 0;
    }
    .api-message a {
      color: #0056b3;
      text-decoration: none;
      font-weight: bold;
    }
    .api-message a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>eCFR Analyzer Dashboard</h1>
  
  <div class="dashboard">
    <div class="chart-container">
      <h2>Word Count per Agency</h2>
      <canvas id="wordCountChart"></canvas>
    </div>

    <div class="chart-container">
      <h2>Word Count Distribution (%)</h2>
      <canvas id="wordCountPieChart"></canvas>
    </div>

    <div class="chart-container">
      <h2>Historical Regulation Updates</h2>
      <canvas id="historicalChart"></canvas>
    </div>

    <div class="chart-container">
      <h2>Cumulative Regulation Changes</h2>
      <canvas id="cumulativeChart"></canvas>
    </div>

    <div class="chart-container hierarchy">
      <h2>Agency Hierarchy</h2>
      <div id="agency-hierarchy"></div>
    </div>

    <div class="chart-container">
      <h2>Corrections Analysis</h2>
      <canvas id="correctionsChart"></canvas>
    </div>

    <div class="chart-container">
      <h2>Corrections Timeline</h2>
      <canvas id="correctionsTimelineChart"></canvas>
    </div>

    <div class="chart-container hierarchy">
      <h2>Title Status</h2>
      <div id="titleStatus" class="status-board"></div>
    </div>
  </div>

  <script>
    // Existing word count chart
    fetch('/api/word_counts')
      .then(response => response.json())
      .then(data => {
        const agencies = Object.keys(data);
        const wordCounts = Object.values(data);
        
        // Calculate total words for percentage
        const totalWords = wordCounts.reduce((sum, count) => sum + count, 0);
        
        // Bar Chart
        const ctx = document.getElementById('wordCountChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: agencies,
            datasets: [{
              label: 'Word Count',
              data: wordCounts,
              backgroundColor: 'rgba(54, 162, 235, 0.5)'
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw;
                    const percentage = ((value / totalWords) * 100).toFixed(1);
                    return `Words: ${value.toLocaleString()} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });

        // Pie Chart
        const pieCtx = document.getElementById('wordCountPieChart').getContext('2d');
        new Chart(pieCtx, {
          type: 'pie',
          data: {
            labels: agencies,
            datasets: [{
              data: wordCounts,
              backgroundColor: [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(199, 199, 199, 0.7)',
                'rgba(83, 102, 255, 0.7)',
                'rgba(40, 159, 64, 0.7)',
                'rgba(210, 199, 199, 0.7)',
                'rgba(78, 52, 199, 0.7)',
                'rgba(225, 109, 64, 0.7)',
              ]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  boxWidth: 12,
                  font: {
                    size: 11
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw;
                    const percentage = ((value / totalWords) * 100).toFixed(1);
                    return `${context.label}: ${percentage}% (${value.toLocaleString()} words)`;
                  }
                }
              }
            }
          }
        });
      })
      .catch(err => console.error("Error fetching word counts:", err));

    // Existing historical changes chart
    fetch('/api/historical')
      .then(response => response.json())
      .then(data => {
        const dates = Object.keys(data);
        const updateCounts = Object.values(data);

        // Calculate cumulative counts
        const cumulativeCounts = updateCounts.reduce((acc, curr, i) => {
          const prev = i > 0 ? acc[i - 1] : 0;
          acc.push(prev + curr);
          return acc;
        }, []);
        
        // Regular updates chart
        const ctx = document.getElementById('historicalChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Updates per Period',
              data: updateCounts,
              backgroundColor: 'rgba(255, 99, 132, 0.5)',
              borderColor: 'rgba(255, 99, 132, 1)',
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: { 
              y: { 
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Number of Updates'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Date'
                }
              }
            }
          }
        });

        // Cumulative changes chart
        const cumCtx = document.getElementById('cumulativeChart').getContext('2d');
        new Chart(cumCtx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Total Accumulated Changes',
              data: cumulativeCounts,
              backgroundColor: 'rgba(75, 192, 192, 0.3)',
              borderColor: 'rgba(75, 192, 192, 1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Total Changes'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Date'
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `Total Changes: ${context.raw.toLocaleString()}`;
                  }
                }
              }
            }
          }
        });
      })
      .catch(err => console.error("Error fetching historical data:", err));

    // New Agency Hierarchy visualization using collapsible list
    fetch('/api/agency_hierarchy')
      .then(response => response.json())
      .then(data => {
        // Check if we need to show API access message
        if (data.message && data.name === "API Access Required") {
          const container = document.getElementById('agency-hierarchy');
          container.innerHTML = `
            <div class="api-message">
              <h3>${data.name}</h3>
              <p>${data.message}</p>
              <p><a href="https://www.ecfr.gov/reader-aids/ecfr-developer-resources/rest-api-interactive-documentation" target="_blank">
                Click here to register your IP address
              </a></p>
            </div>
          `;
          return;
        }

        const container = document.getElementById('agency-hierarchy');
        
        // Add search input
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.placeholder = 'Search agencies...';
        searchInput.className = 'agency-search';
        container.appendChild(searchInput);

        // Create the main list
        const list = document.createElement('ul');
        list.className = 'agency-list';
        container.appendChild(list);

        function createAgencyItem(agency) {
          const li = document.createElement('li');
          li.className = 'agency-item';

          const header = document.createElement('div');
          header.className = 'agency-header';

          const toggleBtn = document.createElement('span');
          toggleBtn.className = 'toggle-btn' + (!agency.children?.length ? ' leaf' : '');
          toggleBtn.textContent = '+';

          const name = document.createElement('span');
          name.className = 'agency-name';
          name.textContent = agency.name;

          header.appendChild(toggleBtn);
          header.appendChild(name);
          li.appendChild(header);

          if (agency.titles?.length) {
            const titles = document.createElement('div');
            titles.className = 'agency-titles';
            // Deduplicate titles and sort them
            const uniqueTitles = [...new Set(agency.titles)].sort((a, b) => a - b);
            titles.textContent = `Titles: ${uniqueTitles.join(', ')}`;
            titles.title = 'CFR Titles regulated by this agency';
            li.appendChild(titles);
          }

          if (agency.children?.length) {
            const childList = document.createElement('ul');
            childList.style.display = 'none';
            agency.children.forEach(child => {
              childList.appendChild(createAgencyItem(child));
            });
            li.appendChild(childList);

            toggleBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const isExpanded = toggleBtn.textContent === '-';
              toggleBtn.textContent = isExpanded ? '+' : '-';
              childList.style.display = isExpanded ? 'none' : 'block';
            });
          }

          return li;
        }

        // Render the hierarchy
        list.appendChild(createAgencyItem(data));

        // Implement search functionality
        searchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const allItems = container.getElementsByClassName('agency-item');
          
          Array.from(allItems).forEach(item => {
            const name = item.querySelector('.agency-name').textContent.toLowerCase();
            const titles = item.querySelector('.agency-titles')?.textContent.toLowerCase() || '';
            
            if (name.includes(searchTerm) || titles.includes(searchTerm)) {
              item.style.display = 'block';
              // Expand parent items
              let parent = item.parentElement;
              while (parent && !parent.classList.contains('agency-list')) {
                if (parent.style.display === 'none') {
                  parent.style.display = 'block';
                  const toggleBtn = parent.parentElement.querySelector('.toggle-btn');
                  if (toggleBtn) toggleBtn.textContent = '-';
                }
                parent = parent.parentElement;
              }
              // Highlight matching text
              item.classList.add('highlight');
            } else {
              if (!hasVisibleChildren(item)) {
                item.style.display = 'none';
              }
              item.classList.remove('highlight');
            }
          });
        });

        function hasVisibleChildren(item) {
          const childList = item.querySelector('ul');
          if (!childList) return false;
          
          const children = childList.getElementsByClassName('agency-item');
          return Array.from(children).some(child => child.style.display !== 'none');
        }
      })
      .catch(err => console.error("Error fetching agency hierarchy:", err));

    // New Corrections Analysis charts
    fetch('/api/corrections_analysis')
      .then(response => response.json())
      .then(data => {
        // Corrections by Title
        const ctx = document.getElementById('correctionsChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(data.by_title),
            datasets: [{
              label: 'Corrections per Title',
              data: Object.values(data.by_title),
              backgroundColor: 'rgba(75, 192, 192, 0.5)'
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
          }
        });

        // Corrections Timeline
        const timelineCtx = document.getElementById('correctionsTimelineChart').getContext('2d');
        new Chart(timelineCtx, {
          type: 'line',
          data: {
            labels: Object.keys(data.by_date),
            datasets: [{
              label: 'Corrections over Time',
              data: Object.values(data.by_date),
              borderColor: 'rgba(153, 102, 255, 1)',
              backgroundColor: 'rgba(153, 102, 255, 0.2)',
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
          }
        });
      })
      .catch(err => console.error("Error fetching corrections data:", err));

    // Title Status Board
    fetch('/api/title_status')
      .then(response => response.json())
      .then(data => {
        const statusBoard = document.getElementById('titleStatus');
        data.forEach(title => {
          const card = document.createElement('div');
          card.className = `status-card ${title.processing ? 'processing' : ''}`;
          card.innerHTML = `
            <h3>Title ${title.number}</h3>
            <p>${title.name}</p>
            <p>Last Amendment: ${title.latest_amendment || 'N/A'}</p>
            <p>Up to Date: ${title.up_to_date_as_of || 'N/A'}</p>
            ${title.processing ? '<p><em>Processing...</em></p>' : ''}
          `;
          statusBoard.appendChild(card);
        });
      })
      .catch(err => console.error("Error fetching title status:", err));
  </script>
</body>
</html>
